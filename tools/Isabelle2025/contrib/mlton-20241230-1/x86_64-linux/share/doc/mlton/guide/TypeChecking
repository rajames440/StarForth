<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>TypeChecking</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="./rouge-github.css">
<link rel="stylesheet" href="./mlton.css">

</head>
<body class="article">
<div id="mlton-header">
<div id="mlton-header-text">
<h2>
<a href="./Home">
MLton
20241230
</a>
</h2>
</div>
</div>
<div id="header">
<h1>TypeChecking</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>MLton&#8217;s type checker follows the <a href="DefinitionOfStandardML">Definition</a>
closely, so you may find differences between MLton and other SML
compilers that do not follow the Definition so closely.  In
particular, SML/NJ has many deviations from the Definition&#8201;&#8212;&#8201;please
see <a href="SMLNJDeviations">SMLNJDeviations</a> for those that we are aware of.</p>
</div>
<div class="paragraph">
<p>In some respects MLton&#8217;s type checker is more powerful than other SML
compilers, so there are programs that MLton accepts that are rejected
by some other SML compilers.  These kinds of programs fall into a few
simple categories.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MLton resolves flexible record patterns using a larger context than
many other SML compilers.  For example, MLton accepts the
following.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sml"><span class="kr">fun</span> <span class="nf">f</span> <span class="p">{</span><span class="n">x</span><span class="p">,</span> <span class="p">...}</span> <span class="p">=</span> <span class="n">x</span>
<span class="kr">val</span> <span class="nv">_</span> <span class="p">=</span> <span class="n">f</span> <span class="p">{</span><span class="n">x</span> <span class="p">=</span> <span class="mi">13</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="s2">"foo"</span><span class="p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>MLton uses as large a context as possible to resolve the type of
variables constrained by the value restriction to be monotypes.  For
example, MLton accepts the following.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sml"><span class="kr">structure</span> <span class="nn">S</span><span class="p">:</span>
   <span class="kr">sig</span>
      <span class="kr">val</span> <span class="nv">f</span><span class="p">:</span> <span class="n">int</span> <span class="p">-&gt;</span> <span class="n">int</span>
   <span class="kr">end</span> <span class="p">=</span>
   <span class="kr">struct</span>
      <span class="kr">val</span> <span class="nv">f</span> <span class="p">=</span> <span class="p">(</span><span class="kr">fn</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="kr">fn</span> <span class="n">y</span> <span class="p">=&gt;</span> <span class="n">y</span><span class="p">)</span>
   <span class="kr">end</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_type_error_messages">Type error messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To aid in the understanding of type errors, MLton&#8217;s type checker
displays type errors differently than other SML compilers.  In
particular, when two types are different, it is important for the
programmer to easily understand why they are different.  So, MLton
displays only the differences between two types that don&#8217;t match,
using underscores for the parts that match.  For example, if a
function expects <code>real * int</code> but gets <code>real * real</code>, the type error
message would look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>expects: _ * [int]
but got: _ * [real]</pre>
</div>
</div>
<div class="paragraph">
<p>As another aid to spotting differences, MLton places brackets <code>[]</code>
around the parts of the types that don&#8217;t match.  A common situation is
when a function receives a different number of arguments than it
expects, in which case you might see an error like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>expects: [int * real]
but got: [int * real * string]</pre>
</div>
</div>
<div class="paragraph">
<p>The brackets make it easy to see that the problem is that the tuples
have different numbers of components&#8201;&#8212;&#8201;not that the components don&#8217;t
match.  Contrast that with a case where a function receives the right
number of arguments, but in the wrong order, in which case you might
see an error like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>expects: [int] * [real]
but got: [real] * [int]</pre>
</div>
</div>
<div class="paragraph">
<p>Here the brackets make it easy to see that the components do not match.</p>
</div>
<div class="paragraph">
<p>We appreciate feedback on any type error messages that you find
confusing, or suggestions you may have for improvements to error
messages.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_shortestmost_recent_rule_for_type_names">The shortest/most-recent rule for type names</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a type error message, MLton often has a number of choices in
deciding what name to use for a type.  For example, in the following
type-incorrect program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sml"><span class="kr">type</span> <span class="kt">t</span> <span class="p">=</span> <span class="n">int</span>
<span class="kr">fun</span> <span class="nf">f</span> <span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">t</span><span class="p">)</span> <span class="p">=</span> <span class="n">x</span>
<span class="kr">val</span> <span class="nv">_</span> <span class="p">=</span> <span class="n">f</span> <span class="s2">"foo"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MLton reports the error message</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: z.sml 3.9-3.15.
  Function applied to incorrect argument.
    expects: [t]
    but got: [string]
    in: f "foo"</pre>
</div>
</div>
<div class="paragraph">
<p>MLton could have reported <code>expects: [int]</code> instead of <code>expects: [t]</code>.
However, MLton uses the shortest/most-recent rule in order to decide
what type name to display.  This rule means that, at the point of the
error, MLton first looks for the shortest name for a type in terms of
number of structure identifiers (e.g. <code>foobar</code> is shorter than <code>A.t</code>).
Next, if there are multiple names of the same length, then MLton uses
the most recently defined name.  It is this tiebreaker that causes
MLton to prefer <code>t</code> to <code>int</code> in the above example.</p>
</div>
<div class="paragraph">
<p>In signature matching, most recently defined is not taken to include
all of the definitions introduced by the structure (since the matching
takes place outside the structure and before it is defined).  For
example, in the following type-incorrect program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sml"><span class="kr">structure</span> <span class="nn">S</span><span class="p">:</span>
   <span class="kr">sig</span>
      <span class="kr">val</span> <span class="nv">x</span><span class="p">:</span> <span class="n">int</span>
   <span class="kr">end</span> <span class="p">=</span>
   <span class="kr">struct</span>
      <span class="kr">type</span> <span class="kt">t</span> <span class="p">=</span> <span class="n">int</span>
      <span class="kr">val</span> <span class="nv">x</span> <span class="p">=</span> <span class="s2">"foo"</span>
   <span class="kr">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MLton reports the error message</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: z.sml 2.4-4.6.
  Variable in structure disagrees with signature (type): x.
    structure: val x: [string]
    defn at: z.sml 7.11-7.11
    signature: val x: [int]
    spec at: z.sml 3.11-3.11</pre>
</div>
</div>
<div class="paragraph">
<p>If there is a type that only exists inside the structure being
matched, then the prefix <code>_str.</code> is used.  For example, in the
following type-incorrect program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sml"><span class="kr">structure</span> <span class="nn">S</span><span class="p">:</span>
   <span class="kr">sig</span>
      <span class="kr">val</span> <span class="nv">x</span><span class="p">:</span> <span class="n">int</span>
   <span class="kr">end</span> <span class="p">=</span>
   <span class="kr">struct</span>
      <span class="kr">datatype</span> <span class="kt">t</span> <span class="p">=</span> <span class="nc">T</span>
      <span class="kr">val</span> <span class="nv">x</span> <span class="p">=</span> <span class="n">T</span>
   <span class="kr">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MLton reports the error message</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: z.sml 2.4-4.6.
  Variable in structure disagrees with signature (type): x.
    structure: val x: [_str.t]
    defn at: z.sml 7.11-7.11
    signature: val x: [int]
    spec at: z.sml 3.11-3.11</pre>
</div>
</div>
<div class="paragraph">
<p>in which the <code>[_str.t]</code> refers to the type defined in the structure.</p>
</div>
</div>
</div>
</div>
<div id="mlton-footer">
<div id="mlton-footer-text">
<div>
Last updated Thu Oct 21 15:53:06 2021 -0400 by Matthew Fluet.
<a href="https://github.com/MLton/mlton/commits/master/doc/guide/src/TypeChecking.adoc">Log</a>
<a href="https://github.com/MLton/mlton/edit/master/doc/guide/src/TypeChecking.adoc">Edit</a>
</div>
</div>
</body>
</html>