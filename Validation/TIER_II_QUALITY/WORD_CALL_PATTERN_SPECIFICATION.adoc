////
StarForth Word Call Pattern Specification

Document Metadata:
- Document ID: starforth-governance/word-call-pattern-specification
- Version: 1.0.0
- Purpose: Document how words are executed and called
- Status: READY FOR VALIDATION
////

= StarForth Word Call Pattern Specification

**Document ID:** starforth-governance/word-call-pattern-specification
**Version:** 1.0.0
**Date:** 2025-10-25

---

== Execution Flow

```
1. Parser reads next word from input
   |
   ↓
2. Dictionary lookup (find_word)
   - Search linked list from most recent to oldest
   - O(n) search time
   |
   ↓
3. Return DictEntry if found
   - Contains: name, flags, func pointer, body, ACL cache
   |
   ↓
4. Check execution context
   - IMMEDIATE flag? Execute now
   - In COMPILE mode? Compile reference
   - In INTERPRET mode? Execute
   |
   ↓
5. Execute word function
   void word_func(struct VM *vm)
   - Pops arguments from data stack
   - Performs operation
   - Pushes results back
```

---

== Standard Word Signature

All FORTH-79 core words follow:

```c
void word_name(struct VM *vm)
{
    // Standard access pattern:
    // 1. Pop arguments from data stack
    cell_t arg1 = vm->data_stack[--vm->sp];
    cell_t arg2 = vm->data_stack[--vm->sp];

    // 2. Perform operation
    cell_t result = arg1 + arg2;

    // 3. Push results back
    vm->data_stack[vm->sp++] = result;
}
```

---

== ACL Integration Points

### At Dictionary Lookup (Before EXECUTE)

**Current Code:**
```c
DictEntry *word = find_word(vm, name);
if (word) {
    word->func(vm);  // Execute immediately
}
```

**With ACL:**
```c
DictEntry *word = find_word(vm, name);
if (word) {
    if (check_acl(vm->current_capability, word->required_capability)) {
        word->func(vm);  // Execute if capability granted
    } else {
        stack_push(vm, 0);  // Push error code
        // Or throw exception
    }
}
```

### During Word Execution (Function Entry)

**Current Code:**
```c
void word_add(struct VM *vm)
{
    // Direct stack access
}
```

**With ACL (Optional):**
```c
void word_add(struct VM *vm)
{
    // Capability already checked at lookup
    // No need for re-check here
}
```

### On Memory Access

**Current Code:**
```c
cell_t vm_load_cell(struct VM *vm, vaddr_t addr)
{
    if (addr >= vm->memory_size) error;
    return vm->memory[addr];
}
```

**With ACL (Optional):**
```c
cell_t vm_load_cell(struct VM *vm, vaddr_t addr)
{
    if (addr >= vm->memory_size) error;
    if (!check_memory_acl(vm->current_capability, addr, READ)) error;
    return vm->memory[addr];
}
```

---

== Word Categories

### Stack Operations (11 words)

Examples: DUP, DROP, SWAP, OVER, ROT
- No memory access
- Only operate on stacks
- No system side effects

### Arithmetic (18 words)

Examples: +, -, *, /, MOD
- No memory access beyond stack
- Deterministic computation
- No side effects

### Memory Operations (6 words)

Examples: @, !, C@, C!
- **Require ACL:** Memory read/write capability
- Address validation needed
- Bounds checking required

### Control Flow (16+ words)

Examples: IF, THEN, DO, LOOP
- **Require ACL:** None for logic itself
- Sub-word execution inherits parent ACL
- Nested definitions follow parent capability

### Dictionary Operations (9 words)

Examples: :, ;, ALLOT, HERE, CREATE
- **Require ACL:** Dictionary modification capability
- Add new words to dictionary
- Allocate dictionary space

### I/O Operations (5 words)

Examples: EMIT, KEY, CR, TYPE
- **Require ACL:** I/O capability
- Character output/input
- Terminal interaction

### System Words (6+ words)

Examples: QUIT, ABORT, COLD, WARM
- **Require ACL:** System capability
- State reset/modification
- Process control

---

== Capability Model

### Proposed Capabilities

- **READ:** Memory read access
- **WRITE:** Memory write access
- **EXECUTE:** Word execution
- **ALLOCATE:** Dictionary allocation
- **DEFINE:** Create new words
- **IO:** Terminal I/O operations
- **SYSTEM:** System-level operations

### Word Capability Requirements

[cols="1,2"]
|===
| Word Category | Required Capabilities

| Stack ops | EXECUTE (word itself)
| Arithmetic | EXECUTE (word itself)
| Memory read (@, C@) | EXECUTE + READ
| Memory write (!, C!) | EXECUTE + WRITE
| Dictionary (ALLOT, HERE) | EXECUTE + ALLOCATE
| Definition (:, ;) | EXECUTE + DEFINE
| I/O (EMIT, KEY) | EXECUTE + IO
| System (QUIT, ABORT) | EXECUTE + SYSTEM
|===

---

## Document Approval & Signature

[cols="2,2,1"]
|===
| Role | Name/Title | Signature

| **Author/Maintainer**
| Robert A. James
|

| **Date Approved**
| 25 oCTOBER, 2025| _______________

|===

**Archive Location:** ~/StarForth-Governance/Validation/TIER_II_QUALITY/