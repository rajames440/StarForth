== Integration Scripts Documentation
:toc: left
:toc-title: Contents
:toclevels: 3
xref:./README.adoc[‚Üê Back to Documentation Index]



=== Overview

Two complementary sync scripts for bidirectional integration between
StarForth and StarshipOS.

=== Scripts

==== 1. `+integrator.sh+` (StarForth ‚Üí StarshipOS) ‚úÖ WORKING

* *Location*: `+StarForth/maint/integrator.sh+`
* *Direction*: StarForth ‚Üí StarshipOS
* *Source*: StarForth root
* *Destination*: `+$STARSHIPOS_ROOT/l4/pkg/starforth/server+`
* *Quarantine*: `+StarForth/maint/quarantine+`
* *Path stripping*: Strips `+server/+` prefix from files
* *Status*: Fully debugged and tested (spent all day on this)

==== 2. `+integrator.sh+` (StarshipOS ‚Üí StarForth) üÜï NEW

* *Final Location*: `+StarshipOS/maint/integrator.sh+`
* *Direction*: StarshipOS ‚Üí StarForth (reverse)
* *Source*: StarshipOS root
* *Destination*: `+$STARFORTH_ROOT+`
* *Quarantine*: `+StarshipOS/maint/quarantine+`
* *Path stripping*: Strips `+l4/pkg/starforth/server/+` prefix from
files
* *Status*: Generated based on working integrator.sh, needs testing

=== The Rules (Cap‚Äôt Bob Sez)

[arabic]
. *Never mkdir into target* ‚Äî both repos must already exist
. *Blacklist = Law* ‚Äî anything matching it is ignored
. *If file exists at same relative path in destination* ‚Üí overwrite
(green)
. *Otherwise* ‚Üí quarantine for review (orange)

=== How They Work

Both scripts: 1. Read files from `+maint/mergefiles.txt+` (or generate
from `+git diff --name-only HEAD~1+`) 2. Check each file against
`+maint/blacklist.txt+` 3. Strip appropriate path prefix to compute
destination path 4. If destination exists ‚Üí overwrite (safe) 5. If
destination doesn‚Äôt exist ‚Üí quarantine for Captain‚Äôs review 6. Refresh
git index when done

=== Next Steps

* [ ] Move `+integrator.sh+` to `+StarshipOS/maint/+`
* [ ] Test `+integrator.sh+` in StarshipOS
* [ ] Verify blacklist.txt and mergefiles.txt exist in StarshipOS/maint/
* [ ] Test round-trip sync (both directions)

=== Notes

* Both scripts are meant to be run from their respective repository
roots
* Quarantine prevents accidental file creation in unexpected locations
* The path stripping logic is the key difference between the two scripts

=== ‚ö†Ô∏è Special Cases

==== Documentation Directory (`+docs/+`)

*Issue*: Documentation needs bidirectional sync but has different paths:
- StarForth: `+docs/+` - StarshipOS: `+l4/pkg/starforth/docs/+`

*Current Status*: ‚è≥ *NOT YET INTEGRATED* - Manual handling required
*Captain‚Äôs Note*: Will be integrated into integrator.sh later with
custom path mapping logic

*Paths*: - `+/home/rajames/CLionProjects/StarForth/docs+` -
`+/home/rajames/CLionProjects/StarshipOS/l4/pkg/starforth/docs+`

*Future Enhancement*: Add special case handling in both integrators for
`+docs/+` directory with custom path transformations

'''''

=== Test & Repair Cycle (StarshipOS ‚Üí StarForth)

==== Date: 2025-10-19

==== Status: ‚úÖ PRODUCTION READY

This section documents the complete debugging process for
`+StarshipOS/maint/integrator.sh+`. Use this methodology to test and
debug the reverse script (`+StarForth/maint/integrator.sh+`).

'''''

==== üêõ Bugs Found & Fixed

===== Bug #1: Blacklist Regex Matching (Line 43) - CRITICAL

*Problem*: Used `+grep -Fqx+` which treats patterns as *fixed strings*,
but `+blacklist.txt+` contains *regex patterns* like
`+(^|/)?Makefile($|[.].*)+`.

*Symptom*: Makefiles and blacklisted files were NOT being blocked.

*Original Code*:

[source,bash]
----
if grep -Fqx -f "$BLACKLIST" <<< "$FILE"; then
----

*Fix*:

[source,bash]
----
if grep -Eq -f <(sed '/^[[:space:]]*$/d; /^[[:space:]]*#/d' "$BLACKLIST") <<< "$FILE"; then
----

*Changes*: - `+-F+` removed (enables regex) - `+-x+` removed (allows
partial line matching) - `+-E+` added (extended regex) - `+sed+` filter
added (see Bug #2)

'''''

===== Bug #2: Empty Lines in Blacklist - CRITICAL

*Problem*: Line 5 in `+blacklist.txt+` is empty. Empty patterns in
`+grep -f+` match *everything*.

*Symptom*: ALL files were being blocked when blacklist was enabled.

*Test*:

[source,bash]
----
# This blocks EVERYTHING because of empty line:
echo "any_file.txt" | grep -Eq -f blacklist.txt && echo "BLOCKED"

# This works correctly:
echo "any_file.txt" | grep -Eq -f <(sed '/^[[:space:]]*$/d; /^[[:space:]]*#/d' blacklist.txt)
----

*Fix*: Filter out empty lines and comments using
`+sed '/^[[:space:]]*$/d; /^[[:space:]]*#/d'+`

'''''

===== Bug #3: Case Sensitivity in mergefiles.txt - MINOR

*Problem*: `+mergefiles.txt+` listed `+testing.md+` but actual file is
`+TESTING.md+`.

*Symptom*: File skipped by line 40 (`+[[ -f "$SRC" ]] || continue+`).

*Fix*: Corrected filename in `+mergefiles.txt+`.

'''''

==== üìã Testing Methodology

===== Phase 1: Basic Execution Test

[source,bash]
----
# Run with existing mergefiles.txt
bash maint/integrator.sh
----

*Expected*: Script runs without errors, processes files listed in
`+mergefiles.txt+`.

'''''

===== Phase 2: Blacklist Enforcement Test

Create comprehensive test file:

[source,bash]
----
cat > maint/mergefiles_blacklist_test.txt << 'EOF'
l4/pkg/starforth/server/Makefile
l4/pkg/starforth/server/Makefile.inc
l4/pkg/starforth/server/README.md
l4/pkg/starforth/server/src/panic.c
l4/pkg/starforth/server/src/core.c
l4/pkg/starforth/server/Control
maint/integrator.sh
EOF

# Create test file that should be quarantined
touch l4/pkg/starforth/server/src/core.c

# Clear quarantine
rm -rf maint/quarantine/*

# Swap mergefiles and run test
cp maint/mergefiles.txt maint/mergefiles.txt.backup
cp maint/mergefiles_blacklist_test.txt maint/mergefiles.txt
bash maint/integrator.sh
----

*Expected Results*: | File | Expected Action | Reason | |‚Äî‚Äî|‚Äî‚Äî‚Äî‚Äî‚Äî-|‚Äî‚Äî‚Äî|
| `+Makefile+` | üî¥ *BLOCKED* | Matches `+(^|/)?Makefile($|[.].*)+` | |
`+Makefile.inc+` | üî¥ *BLOCKED* | Matches `+(^|/)?Makefile($|[.].*)+` |
| `+README.md+` | üü¢ *OVERWRITE* | Not blacklisted, exists in StarForth
| | `+panic.c+` | üî¥ *BLOCKED* | Matches `+server/src/panic\.c$+` | |
`+core.c+` | üü† *QUARANTINE* | Not blacklisted, doesn‚Äôt exist in
StarForth | | `+Control+` | üî¥ *BLOCKED* | Matches
`+(^|/)?Control($|/)+` | | `+integrator.sh+` | üü¢ *OVERWRITE* | Not
blacklisted, exists in StarForth |

*Verify Blacklist*:

[source,bash]
----
# Test individual patterns
echo "l4/pkg/starforth/server/Makefile" | grep -Eq -f <(sed '/^[[:space:]]*$/d; /^[[:space:]]*#/d' maint/blacklist.txt) && echo "BLOCKED" || echo "NOT BLOCKED"

echo "l4/pkg/starforth/server/src/panic.c" | grep -Eq -f <(sed '/^[[:space:]]*$/d; /^[[:space:]]*#/d' maint/blacklist.txt) && echo "BLOCKED" || echo "NOT BLOCKED"
----

'''''

===== Phase 3: Path Stripping Verification

*Test*: Verify that `+l4/pkg/starforth/server/+` prefix is correctly
stripped.

[source,bash]
----
# Check where files land in destination
FILE="l4/pkg/starforth/server/README.md"
RELATIVE="${FILE#l4/pkg/starforth/server/}"
echo "Source: $FILE"
echo "Destination: $STARFORTH_ROOT/$RELATIVE"
----

*Expected*: - Source: `+l4/pkg/starforth/server/README.md+` -
Destination: `+/home/rajames/CLionProjects/StarForth/README.md+`

*Verify*:

[source,bash]
----
diff l4/pkg/starforth/server/README.md $STARFORTH_ROOT/README.md && echo "‚úì Synced correctly"
----

'''''

===== Phase 4: Overwrite vs Quarantine Logic

*Rule 3*: If file exists at destination ‚Üí *overwrite* (green) *Rule 4*:
If file doesn‚Äôt exist ‚Üí *quarantine* (orange)

*Test Overwrite*:

[source,bash]
----
# README.md exists in StarForth root
test -f $STARFORTH_ROOT/README.md && echo "Exists ‚Üí should OVERWRITE"
----

*Test Quarantine*:

[source,bash]
----
# core.c doesn't exist in StarForth
test -f $STARFORTH_ROOT/src/core.c || echo "Doesn't exist ‚Üí should QUARANTINE"

# Verify it's quarantined
test -f maint/quarantine/l4/pkg/starforth/server/src/core.c && echo "‚úì Correctly quarantined"
----

'''''

===== Phase 5: Auto-Generation from Git (Webhook Mode)

*Test*: Script generates `+mergefiles.txt+` from
`+git diff --name-only HEAD~1+` when file doesn‚Äôt exist.

[source,bash]
----
# Remove mergefiles.txt to trigger auto-generation
mv maint/mergefiles.txt maint/mergefiles.txt.manual

# Run script - should auto-generate
bash maint/integrator.sh

# Check what was generated
cat maint/mergefiles.txt
----

*Expected Output*:

....
[INFO] No mergefiles list found ‚Äî generating diff from last commit.
....

*Verify*:

[source,bash]
----
git diff --name-only HEAD~1  # Should match mergefiles.txt content
----

'''''

==== ‚úÖ Final Production Test

[source,bash]
----
# 1. Restore original mergefiles.txt
cp maint/mergefiles.txt.backup maint/mergefiles.txt

# 2. Clear quarantine
rm -rf maint/quarantine/*

# 3. Run production test
bash maint/integrator.sh

# 4. Verify sync
diff maint/integrator.sh $STARFORTH_ROOT/maint/integrator.sh && echo "‚úì Synced"
----

*Expected Output*:

....
üõ∞Ô∏è  Quark webhook engaged ‚Äî StarshipOS ‚Üí StarForth (Reverse Sync)

[Quarantining] l4/pkg/starforth/server/TESTING.md
[Overwriting] maint/integrator.sh

üßæ First Officer's Reverse Report:
  ‚Ä¢ Destination base: /home/rajames/CLionProjects/StarForth
  ‚Ä¢ Quarantine:       /home/rajames/CLionProjects/StarshipOS/maint/quarantine
  ‚Ä¢ Merge list:       2 files processed

Awaiting Cappy's signature: Captain Bob ‚úçÔ∏è
....

'''''

==== üîß Debugging Commands Reference

===== Check Blacklist Patterns

[source,bash]
----
# View blacklist with line numbers
cat -n maint/blacklist.txt

# Test specific file against blacklist
FILE="l4/pkg/starforth/server/Makefile"
grep -Eq -f <(sed '/^[[:space:]]*$/d; /^[[:space:]]*#/d' maint/blacklist.txt) <<< "$FILE" && echo "BLOCKED" || echo "NOT BLOCKED"
----

===== Verify Path Stripping

[source,bash]
----
# For StarshipOS ‚Üí StarForth
FILE="l4/pkg/starforth/server/src/vm.c"
RELATIVE="${FILE#l4/pkg/starforth/server/}"
echo "$RELATIVE"  # Should output: src/vm.c

# For StarForth ‚Üí StarshipOS (reverse)
FILE="server/src/vm.c"
RELATIVE="${FILE#server/}"
echo "$RELATIVE"  # Should output: src/vm.c
----

===== Check File Existence

[source,bash]
----
# Check source
ls -la l4/pkg/starforth/server/TESTING.md

# Check destination
ls -la $STARFORTH_ROOT/TESTING.md

# Check quarantine
ls -la maint/quarantine/l4/pkg/starforth/server/TESTING.md
----

===== Monitor Git Index Refresh

[source,bash]
----
# Manual refresh (what script does)
cd $STARFORTH_ROOT && git update-index --really-refresh
----

'''''

==== üéØ Apply to StarForth ‚Üí StarshipOS Script

Use the same methodology to test `+StarForth/maint/integrator.sh+`:

*Key Differences*: 1. *Path stripping*: `+server/+` ‚Üí
`+l4/pkg/starforth/server/+` 2. *Direction*: StarForth ‚Üí StarshipOS 3.
*Blacklist patterns*: Different (StarForth-specific patterns)

*Same Fixes Needed*: - Change `+grep -Fqx+` ‚Üí `+grep -Eq+` - Add `+sed+`
filter for empty lines and comments - Verify case sensitivity in
mergefiles.txt

*Test Pattern*:

[source,bash]
----
cd /home/rajames/CLionProjects/StarForth

# Phase 1: Basic test
bash maint/integrator.sh

# Phase 2: Blacklist test (create test mergefiles)
# Phase 3: Path stripping test
# Phase 4: Overwrite vs quarantine test
# Phase 5: Auto-generation test
----

'''''

==== üìä Test Results Summary

[width="100%",cols="51%,26%,23%",options="header",]
|===
|Test Category |Status |Notes
|Basic Execution |‚úÖ PASS |Script runs without errors

|Blacklist Enforcement |‚úÖ PASS |Regex patterns work, empty lines
filtered

|Path Stripping |‚úÖ PASS |`+l4/pkg/starforth/server/+` removed correctly

|Overwrite Logic |‚úÖ PASS |Existing files overwritten (README.md, vm.h)

|Quarantine Logic |‚úÖ PASS |New files quarantined (TESTING.md, core.c)

|Auto-Generation |‚úÖ PASS |Generates from `+git diff HEAD~1+`

|Git Index Refresh |‚úÖ PASS |StarForth index updated
|===

*Final Status*: üöÄ *PRODUCTION READY* for git push webhook

'''''

_Debugged: 2025-10-19_ _Captain Bob ‚úçÔ∏è_
