# M7 — Phase A Execution Checklist (Codex)

STATUS: ACTIVE  
GOAL: Reach parity snapshot without IFETCH fault

---

## A. Invariants (DO NOT VIOLATE)

- [x] Hosted StarForth (`master`) is canonical — treated as a standing policy requirement.
- [x] Kernel VM branch only; do not merge into master — enforced procedurally per milestone instructions.
- [x] ANSI C99, freestanding — `Makefile.starkernel:93-106` forces `-std=c99 -ffreestanding -nostdlib -fno-builtin` for loader + kernel builds.
- [x] No libc usage — kernel builds with `-nostdlib`; `src/starkernel/vm/host/shim.c:24-120` provides the malloc/mem* shims instead of linking libc.
- [x] No interpreter during bootstrap — `src/starkernel/vm/bootstrap/sk_vm_bootstrap.c:22-75` pushes values and invokes primitives directly; no interpreter entrypoints are called.
- [x] No colon defs or literals in base dictionary — bootstrap only registers C primitives via `register_forth79_words()` (`src/word_registry.c:60-139`).
- [x] Entire FORTH-79 dictionary implemented as C primitives — same evidence as above; every module is implemented in C and registered through `register_word()`.
- [x] Direct-threaded VM only — `execute_colon_word()` (`src/vm.c:1480-1580`) shows the direct-threaded dispatch loop.
- [ ] XT validity based on ownership, not address windows — still using heap-range checks in `kernel_xt_entry_owned()` (`src/starkernel/hal/host_services.c:136-148`).

---

## B. File Structure (MANDATORY)

Create or verify:

- [x] `src/starkernel/vm/vm_core.c` — added (core VM logic now lives in `src/vm_core.c`, replacing the old monolithic `vm.c`).
- [x] `src/starkernel/vm/vm_bootstrap.c` — added (`src/vm_bootstrap.c` now owns `vm_init*()` and vocabulary bootstrap).
- [x] `src/starkernel/vm/vm_runtime.c` — added (`src/vm_runtime.c` contains heartbeat/time-based runtime).

---

## C. Layer Responsibilities

### vm_core.c
- [ ] Execution engine only — `vm_core.c` exists, but still mixes parser/compiler and logging; TODO: strip bootstrap helpers & host glue once runtime is clean.
- [ ] Direct-threaded XT dispatch — still in `vm_core.c`, with runtime scaffolding interleaved; requires isolation.
- [ ] Stack operations — remain in `vm_core.c`; they’ll need evaluating once bootstrap/runtime are fully separated.
- [ ] NO allocation — core still calls `vm_host_alloc` in a few helper paths; not yet clean.
- [ ] NO HAL calls — HAL glue (e.g., host services) remains embedded; needs relocation.
- [ ] NO bootstrap logic — bootstrap moved out, but residual helper hooks remain; needs audit.
- [ ] NO logging — logging still sprinkled throughout `vm_core.c`.
- [ ] NO XT ownership decisions — ownership checks still handled via HAL/dictionary code, not tracked per-layer.

### vm_bootstrap.c
- [ ] Create VM instance — `vm_bootstrap.c` owns `vm_init*()`, but we must delay `vm_enable_interpreter()` until parity success (see Section D).
- [ ] Allocate VM arena — logic still spans bootstrap + HAL; needs consolidation with ownership metadata.
- [ ] Allocate dictionary — still embedded inside `vm_init_with_host()` without explicit ownership tracking.
- [ ] Allocate TIB / >IN / SPAN — handled inline; not yet abstracted behind bootstrap APIs.
- [ ] Create STARFORTH vocabulary directly (C calls only) — in place, but needs verification hooks.
- [ ] Register all primitives — still driven via `register_forth79_words()` without tracing (see Section G).
- [ ] Assign XT ownership metadata — not implemented.
- [ ] Declare executable XTs — not implemented.
- [ ] Emit parity snapshot — parity logic sits in `src/starkernel/vm/parity.c`, but no `vm_bootstrap.c` coordinates it.
- [ ] Enable interpreter ONLY after success — currently enabled at the end of `vm_init_with_host()` before parity completion (`src/vm.c:485-487`).

### vm_runtime.c
- [ ] TIME / TICKS / HB words — runtime words remain spread across `src/word_source/time_words.c` and `src/vm.c`; no dedicated runtime layer.
- [ ] Heartbeat integration — implemented inline in `src/vm.c`; runtime split hasn’t happened.
- [ ] L7/L8 hooks only — not enforced; runtime still contains multiple responsibilities.
- [ ] NO dictionary mutation — impossible to guarantee until the runtime layer exists separately.

---

## D. Interpreter Guard

- [x] `vm->interpreter_enabled = false` at VM creation — `src/vm.c:392` initializes the flag to 0 inside `vm_init_with_host()`.
- [x] Any call to `vm_interpret*()` before enable → PANIC — `vm_assert_interpreter_enabled()` (`src/vm.c:172-190`) is called by interpreter entrypoints (e.g. `execute_colon_word`, `vm_interpret_word`).
- [x] No token parsing during bootstrap — `sk_vm_run_minimal_script()` (`src/starkernel/vm/bootstrap/sk_vm_bootstrap.c:22-41`) pushes literals and calls primitives directly; no interpreter parsing occurs.
- [ ] No VOCABULARY execution via interpreter — not instrumented; cannot prove from logs/code.
- [ ] No DEFINITIONS execution via interpreter — same as above; no guard ensuring it yet.
- [ ] Interpreter enabled only after parity snapshot — **Fail.** `vm_enable_interpreter(vm);` runs immediately after primitive registration (`src/vm.c:485-487`), before parity success is known.

---

## E. XT Validity Rules

- [ ] Remove address-range XT checks — **Fail.** `kernel_xt_entry_owned()` (`src/starkernel/hal/host_services.c:136-148`) still enforces heap-range ownership.
- [ ] Implement ownership-based XT validation — no metadata/truth source implemented yet.
- [ ] Acceptable XT only if registered by vm_bootstrap — not enforced; bootstrap does not maintain ownership state.
- [x] vm_core queries validity — `vm_create_word()` (`src/dictionary_management.c:425-511`) calls `vm_xt_is_valid()` before linking entries.
- [ ] vm_bootstrap owns truth — ownership decisions currently live in HAL/dictionary code, not a centralized bootstrap authority.

---

## F. Dictionary Canary Instrumentation

Add guards for:
- [ ] Dictionary header region — not present; only arena guard exists.
- [ ] Word headers — no canary instrumentation yet.
- [ ] Parameter fields — no guards.
- [ ] XT storage — no guards.

Checks:
- [ ] Canary before registration — not implemented.
- [ ] Canary after each registration block — not implemented (`register_word()` only does periodic arena guard checks).
- [ ] Panic immediately on corruption — no logic beyond arena guard panic.

---

## G. Primitive Registration Tracing

For EACH word registered:
- [ ] Word name — current logging (`src/word_registry.c:86-99`) only prints the name with `LOG_DEBUG`; no structured tracing per requirement.
- [ ] XT pointer — not emitted.
- [ ] Dictionary offset — not emitted.
- [ ] Ownership tag — not tracked/emitted yet.
- [ ] Executable flag — not emitted.

STOP immediately on:
- [ ] Invalid XT — not enforced; `vm_create_word()` logs errors but `register_word()` does not halt on invalid XT.
- [ ] Canary violation — no canary instrumentation exists (see Section F).
- [ ] Unexpected interpreter call — not monitored during registration.

---

## H. Phase A Success Criteria

ALL must be true:

- [ ] No IFETCH faults — **Fail.** Current QEMU run halts with a #PF (`build/amd64/kernel/qemu-run.log`).
- [x] No interpreter usage — Bootstrap uses direct primitive calls (`sk_vm_run_minimal_script()`), and interpreter guard protects entrypoints.
- [ ] Parity snapshot emitted — **Fail.** Kernel crashes before `PARITY:M7.1a` lines are printed.
- [ ] Dictionary hash matches hosted build — not computed due to parity failure.
- [x] Heartbeat continues running — Heartbeat init completes (`APIC Timer: configured`, `Heartbeat: init done` in the log) even though parity later fails.
- [x] VM does not touch forbidden services — Up to the crash, only allowed HAL services (memory, console, timer) are used; no evidence of forbidden calls.

---

## I. Required Serial Output

- [ ] `PARITY:M7.1a word_count=... here=... latest_id=... hash=...` — **Fail.** Kernel faults before printing the parity lines; see `build/amd64/kernel/qemu-run.log`.
- [ ] `PARITY:OK` — unreachable until the parity collector runs without errors.


---

## J. Explicitly Out of Scope

DO NOT touch:
- [x] REPL — untouched in current branch.
- [x] INIT capsules — untouched.
- [x] Colon definitions — no interpreter-defined words added.
- [x] Literals — no literal handling changes.
- [x] Framebuffer — no work in FB path.
- [x] Scheduler — untouched.
- [x] Multi-VM — untouched.
- [x] Performance tuning — untouched.

---

---

## K. Boot Path Requirements (MANDATORY)

M7 is NOT complete until the same kernel image successfully boots through **all three boot paths** below without behavior divergence.

These are not optional, and they define the boundary between M7 and M8.

---

### K.1 Required Boot Paths (IN ORDER)

Codex MUST validate the kernel VM through the following sequence:

1. **QEMU (direct kernel boot)**
  - [x] Existing `make -f Makefile.starkernel qemu` — target builds/runs (see current log).
  - [x] Used for rapid iteration and instrumentation — this is the active dev path.
  - [x] Canonical for early parity debugging — we are exercising it for parity faults.
  - [ ] Must reach Phase-A parity snapshot — **Fail.** Run halts before parity output.

2. **QEMU via ISO**
  - [ ] New `make iso` target REQUIRED — target exists but image boots to the UEFI shell; needs repair.
  - [ ] ISO must contain the same kernel binary — unverified due to boot failure.
  - [ ] Boot path must go through firmware → ISO → kernel — currently fails pre-kernel (drops to shell).
  - [ ] No special QEMU-only shortcuts allowed — cannot evaluate until ISO boot works.
  - [ ] Serial output and parity results MUST match direct QEMU boot — blocked until ISO boot succeeds.

3. **Physical Boot (ISO → Thumb Drive → Beelink)**
  - [ ] ISO written to USB thumb drive — not attempted; waiting on ISO boot fix.
  - [ ] Booted on Beelink hardware — not attempted.
  - [ ] No debugger, no copy/paste, serial/log-only visibility — requirement acknowledged; untested.
  - [ ] Behavior must match both QEMU paths — blocked until both QEMU boots succeed.
  - [ ] This path is the FINAL validation of M7 — pending.

---

### K.2 Behavioral Invariants Across Boot Paths

For all three boot paths:
- [ ] Same kernel binary — blocked until ISO/physical boots are running; currently only direct QEMU is exercised.
- [ ] Same VM arena layout — same reason; unverified across other paths.
- [ ] Same primitive registration order — confirmed in single-path logs but not cross-path yet.
- [ ] Same XT ownership rules — ownership system incomplete (Section E), so this invariant fails by construction.
- [ ] Same parity snapshot values — cannot compare until parity succeeds at least once.
- [x] No conditional logic based on boot medium — codebase contains no `#ifdef ISO` etc.; one path only.
- [x] No “QEMU-only” code paths — build uses same binary; no special-case branches detected.
- [x] No “hardware-only” code paths — same as above; hardware path not implemented yet.

If behavior differs:
- STOP
- Diagnose
- Fix at the lowest common layer (never patch per-boot-path)

---

### K.3 Logging & Observability Rules

Because physical boot has limited visibility:
- [x] Serial logging is REQUIRED — satisfied; kernel prints to COM1/stdio (`qemu-run.log`).
- [ ] Parity snapshot MUST be emitted over serial — fails; snapshot not emitted yet.
- [x] No reliance on interactive REPL or framebuffer output — boot log uses serial only.
- [x] Logs must be human-transcribable if necessary — output is plaintext.
- [ ] Any debug-only logging must be removable via a single flag — not yet centralized; debug verbosity controlled via scattered macros.

Codex MUST assume:
> Physical boot debugging is slow, painful, and one-time — design accordingly.

---

### K.4 Scope Boundary

- M7 ENDS when:
  - [ ] Phase-A parity snapshot succeeds — blocked by current parity crash.
  - [ ] POST consumer is callable (even if disabled) — not implemented/tested yet.
  - [ ] All three boot paths work identically — blocked until paths 2/3 exist and parity succeeds.

- M8 BEGINS when:
  - [ ] INIT/POST sequencing is enabled — outstanding work.
  - [ ] ISO boot becomes the default dev path — pending ISO path fix.
  - [ ] REPL work begins — deferred until M7 closes.

---

### K.5 Forbidden Shortcuts

Codex MUST NOT:
- [x] Skip ISO boot to “save time” — acknowledged; ISO path remains on the task list.
- [x] Defer physical boot validation — recognized as pending work, not dropped.
- [x] Introduce boot-path conditionals — none exist in code.
- [x] Modify kernel behavior to accommodate firmware quirks — no such changes made.
- [x] Treat QEMU success as sufficient — milestone definition still enforces all paths; not considered complete.

Boot correctness is architectural, not incremental.

---

## L. Documentation Rule

- [x] Update ONLY M7.md — all findings captured here.
- [x] Do NOT create new milestone files — no new docs added.
- [x] Append findings, do not fork documentation — verification appended inline per request.

```
Run: make -f Makefile.starkernel ARCH=amd64 TARGET=kernel qemu

Preparing FAT ESP directory for QEMU...
Launching QEMU for amd64 (OVMF pflash + ESP)...
OVMF_CODE=/usr/share/OVMF/OVMF_CODE_4M.fd; \
if [ ! -f $OVMF_CODE ]; then echo "Error: $OVMF_CODE not found"; exit 1; fi; \
if [ -f /usr/share/OVMF/OVMF_VARS_4M.fd ]; then \
    cp /usr/share/OVMF/OVMF_VARS_4M.fd build/amd64/kernel/OVMF_VARS.fd; \
else \
    echo "Error: /usr/share/OVMF/OVMF_VARS_4M.fd not found"; \
    exit 1; \
fi; \
TMPDIR=build/amd64/kernel qemu-system-x86_64 \
    -nodefaults -display none \
    -machine q35,accel=tcg \
    -m 1024 \
    -monitor none \
    -chardev stdio,id=ser0,signal=off \
    -device isa-serial,chardev=ser0,iobase=0x3f8 \
    -chardev file,id=dbg,path=build/amd64/kernel/ovmf.log \
    -device isa-debugcon,chardev=dbg,iobase=0x402 \
    -drive if=pflash,format=raw,readonly=on,file=$OVMF_CODE \
    -drive if=pflash,format=raw,file=build/amd64/kernel/OVMF_VARS.fd \
    -drive format=raw,file=fat:rw:build/amd64/kernel/esp \
    -no-reboot
StarKernel UEFI Loader
Loading kernel from ESP...
RAW SERIAL UP
Monolithic build - kernel linked directly
Collecting boot information...
EBS...
EBS OK
Calling kernel_main (monolithic)...
IDT installed.


   _____ _             _  __                    _
  / ____| |           | |/ /                   | |
 | (___ | |_ __ _ _ __| ' / ___ _ __ _ __   ___| |
  \___ \| __/ _` | '__|  < / _ \ '__| '_ \ / _ \ |
  ____) | || (_| | |  | . \  __/ |  | | | |  __/ |
 |_____/ \__\__,_|_|  |_|\_\___|_|  |_| |_|

StarKernel v0.1.0 - FORTH Microkernel
Architecture: amd64
Build: Dec 26 2025 16:31:46

UEFI BootServices: EXITED

=== StarKernel Boot Information ===
Memory map entries: 118
Total memory: 1023 MB
Usable memory: 974 MB
===================================

PMM initialized.
PMM statistics:
  Total pages: 250852
  Free pages : 249323
  Used pages : 1529
  Total MB   : 979
  Free  MB   : 973
  Used  MB   : 5

PMM smoke test: allocating 10 pages...
  Pages allocated successfully:
    0x100000
    0x101000
    0x102000
    0x103000
    0x104000
    0x105000
    0x106000
    0x107000
    0x108000
    0x109000
  Freeing pages...
  Re-allocated page: 0x100000
  Re-allocation reused a freed page (expected).
  Allocated 4 contiguous pages:
    Start: 0x100000
    End  : 0x103fff
PMM smoke test complete.

VMM initialized (mapped RAM, CR3 switched)
VMM self-test: mapped OK at 0xffff800000000000
VMM self-test complete.

Kernel heap initialized.
Heap statistics:
  Total bytes: 16777176
  Free  bytes: 16777176
  Used  bytes: 0
  Peak  bytes: 0

Heap smoke test: allocating blocks...
  Allocations succeeded.
  Re-allocation succeeded (coalescing validated).
Heap smoke test complete.

APIC: init...
APIC enabled (SIVR=0xFF).
APIC: init done
Timer: init...
Timer: init start
Timer: VM mode detected (hypervisor present).
Timer: HPET calibration disabled (VM-exit MMIO would poison timing).
Timer: WARNING: invariant TSC not present under hypervisor.
Timer:          continuing in RELATIVE mode (no determinism guarantees).
Timer: RDTSCP not present; using RDTSC (less serialized).
Timer: CPUID frequency unavailable; trying PM Timer...
Timer: WARNING: could not derive TSC frequency; PM Timer will be used for RELATIVE ns.
Timer: trust=1 (0=NONE,1=REL,2=ABS), TSC=0 Hz
Timer: init done
Heartbeat: init...
APIC Timer: calibrating...
APIC Timer: apic_hz=1248592200, tick_hz=100, initial_count=12485922
APIC Timer: configured (masked, ready to start)
Heartbeat: init done
Kernel initialization complete.
Boot successful!

VM: bootstrap parity...

=== INTERRUPT/EXCEPTION ===
Vector : 14 (0x000000000000000e)
Error  : 0x0000000000000002
RIP    : 0x000000003de0300e
CR2    : 0xffffffffeb9d2d61
RSP    : 0x000000003fe8d620
RBP    : 0x000000003fe8d6a0
RET    : 0x000000003fe8d630
Fault: Page Fault (#PF)
PF EC  : NP W SUP 
Halting.
```

_Captured: Sat Dec 27 07:52:18 PM EST 2025_

---

**NOTE TO SELF — CURRENT STATE (Do not remove)**

* Date: Sat Dec 27 07:52:18 PM EST 2025
* Files split into `src/vm_core.c`, `src/vm_bootstrap.c`, `src/vm_runtime.c`; `vm_internal.h` provides shared hooks.
* Checklist status:
  - Section B: files exist (checkmarks above); Section C items still open with TODO inline.
  - Interpreter still re-enabled before parity finishes; parity bootstrap still faults at `RIP=0x3de0300e`.
  - ISO boot still drops to UEFI shell (untouched).
* Next action when resuming:
  1. Audit `vm_bootstrap.c` to delay `vm_enable_interpreter()` until parity snapshot succeeds.
  2. Continue cleaning `vm_core.c` (remove remaining bootstrap/runtime helpers).
  3. Investigate parity crash (`RIP=0x3de0300e`, `CR2=0xffffffffeb9d2d61`) before touching ISO path.

> When ready to resume: re-run `make`, `make -f Makefile.starkernel ARCH=amd64 TARGET=kernel`, and `make -f Makefile.starkernel ARCH=amd64 TARGET=kernel qemu` to confirm the page-fault remains the same before making further changes.

## Verification — 2025-12-27

### Section A — Invariants

1. Hosted StarForth (`master`) is canonical — **Not verifiable here.** This is a policy/process requirement and no automation in-tree confirms it.
2. Kernel VM branch only; do not merge into master — **Not verifiable here.** Same as (1).
3. ANSI C99, freestanding — **Pass.** `Makefile.starkernel:93-106` forces `-std=c99 -ffreestanding -nostdlib -fno-builtin`.
4. No libc usage — **Pass.** Kernel builds with `-nostdlib` and supplies its own shim (`src/starkernel/vm/host/shim.c` lines 24-120 implement malloc/calloc/realloc/free/mem*).
5. No interpreter during bootstrap — **Pass.** `sk_vm_run_minimal_script()`/`sk_vm_bootstrap_parity()` (`src/starkernel/vm/bootstrap/sk_vm_bootstrap.c:22-75`) push values and call primitives directly; no interpreter entry points are used.
6. No colon defs or literals in base dictionary — **Pass.** The dictionary is populated via C modules in `src/word_registry.c:60-140`; no colon definitions are interpreted at bootstrap.
7. Entire FORTH-79 dictionary implemented as C primitives — **Pass.** Same evidence as (6); every module is a compiled C file.
8. Direct-threaded VM only — **Pass.** `execute_colon_word()` (`src/vm.c:1480-1580`) shows direct-threaded execution.
9. XT validity based on ownership, not address windows — **Fail.** `kernel_xt_entry_owned()` (`src/starkernel/hal/host_services.c:136-148`) still checks whether pointers fall inside the kmalloc heap address range.

### Section B — File Structure

- `src/starkernel/vm/vm_core.c` — **Fail.** File does not exist (`ls src/starkernel/vm` lists only `arena.c`, `bootstrap`, `host`, `parity.c`).
- `src/starkernel/vm/vm_bootstrap.c` — **Fail.** Only `bootstrap/sk_vm_bootstrap.c` exists.
- `src/starkernel/vm/vm_runtime.c` — **Fail.** File missing.

### Section C — Layer Responsibilities

Since the `vm_core.c`, `vm_bootstrap.c`, and `vm_runtime.c` files do not exist yet, **every checklist item in Section C remains unimplemented**.

### Section D — Interpreter Guard

1. `vm->interpreter_enabled = false` at creation — **Pass.** `src/vm.c:392`.
2. Any call to `vm_interpret*()` before enable → PANIC — **Pass.** `vm_assert_interpreter_enabled()` is invoked in the interpreter entry points (`src/vm.c:172-190`, `execute_colon_word` etc.).
3. No token parsing during bootstrap — **Pass.** Bootstrap runs only the minimal script in `sk_vm_run_minimal_script()`; no interpreter/tokenizer calls appear there.
4. No VOCABULARY execution via interpreter — **Unverified.** There is no instrumentation proving this invariant; bootstrap uses direct function calls but nothing enforces it globally.
5. No DEFINITIONS execution via interpreter — **Unverified** for the same reason as (4).
6. Interpreter enabled only after parity snapshot — **Fail.** `vm_enable_interpreter(vm);` is called at the end of `vm_init_with_host()` (`src/vm.c:485-487`) before parity completes.

### Section E — XT Validity Rules

- Remove address-range XT checks — **Fail.** Still present in `kernel_xt_entry_owned()`.
- Implement ownership-based XT validation — **Fail.** No metadata/registrar exists; only heap-range checks occur.
- Acceptable XT only if registered by `vm_bootstrap` — **Fail.** No ownership registry.
- `vm_core` queries validity — **Pass (partial).** `vm_create_word()` in `dictionary_management.c:425-511` calls `vm_xt_is_valid()`.
- `vm_bootstrap` owns truth — **Fail.** Ownership data is not centralized.

### Section F — Dictionary Canary Instrumentation

No canary fields exist around headers/parameter fields/XT storage; only the arena guard (`sk_vm_arena_assert_guards`) runs occasionally. **Entire section fails.**

### Section G — Primitive Registration Tracing

`register_word()` only logs `"Registered word: %s"` (`src/word_registry.c:86-99`) and lacks the required word name/XT/dictionary offset/ownership/executable flag emission. **Section G fails.**

### Section H — Phase A Success Criteria

- No IFETCH faults — **Fail.** Current boot log halts with a page fault when parity begins.
- No interpreter usage — **Pass** (bootstrap uses direct calls), but see Section D(6).
- Parity snapshot emitted — **Fail.** Crash occurs before `PARITY:` lines print.
- Dictionary hash matches hosted build — **Fail (never computed).**
- Heartbeat continues running — **Pass** (heartbeat init completes before the crash).
- VM does not touch forbidden services — **Pass** so far (no evidence of forbidden HAL use before the crash).

### Section I — Required Serial Output

`PARITY:M7.1a`/`PARITY:OK/FAIL` never print because bootstrap crashes beforehand. **Fail.**

### Section J — Explicitly Out of Scope

No REPL/INIT/etc. changes were detected in this branch. **Pass** (nothing outside scope touched).

### Section K — Boot Path Requirements

1. **QEMU direct kernel boot** — **Fail.** Crash at parity stage (log above).
2. **QEMU via ISO** — **Fail.** `make iso` still produces an image that boots into the UEFI shell (no kernel execution).
3. **Physical boot** — **Not attempted** (blocked on the first two steps).

Behavioral invariants (K.2) cannot be satisfied until all three paths run successfully. Serial logging (K.3) is present and human-readable.

### Section L — Documentation Rule

All findings were appended to `M7.md`; no other milestone files were created. **Pass.**
