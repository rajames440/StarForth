===============================================================================
M7.5 — VM CORE SEPARATION & HAL ALIGNMENT
===============================================================================

Status:
• Applies ONLY to the StarKernel branch
• Master remains canonical HOSTED StarForth
• This is a STRUCTURAL refactor, not a redesign
• ANSI C99 only, freestanding, NO libc dependencies

Goal:
Reduce coupling, enforce HAL boundaries, unblock M7 parity,
and make XT ownership explicit and provable.

This refactor is REQUIRED groundwork before continuing M7.

-------------------------------------------------------------------------------
NON-NEGOTIABLE PRINCIPLES
-------------------------------------------------------------------------------

1. The VM must be layered ABOVE the kernel HAL.
2. VM execution logic must NOT depend on bootstrap, logging, or policy.
3. XT validity is based on OWNERSHIP, not raw address windows.
4. Direct-threaded execution remains intact.
5. No colon definitions or literals in the base dictionary.
6. All FORTH-79 words remain C primitives.
7. No libc, no malloc, no printf, no varargs.

-------------------------------------------------------------------------------
FILE SPLIT OVERVIEW
-------------------------------------------------------------------------------

The existing vm.c MUST be split into the following units:

src/starkernel/vm/
├── vm_core.c
├── vm_bootstrap.c
├── vm_runtime.c
├── vm_core.h
├── vm_bootstrap.h

Do NOT introduce circular dependencies.

-------------------------------------------------------------------------------
vm_core.c  (THE EXECUTION ENGINE)
-------------------------------------------------------------------------------

Purpose:
Implements the FORTH VM execution model ONLY.

Owns:
• Direct-threaded dispatch
• XT execution
• Data stack + return stack mechanics
• Inner interpreter loop
• vm_step / vm_execute_xt / vm_run
• XT validation INTERFACE (not policy)

Must NOT:
• Allocate memory
• Register words
• Touch HAL directly
• Log, print, or heartbeat
• Know about parity or bootstrap

vm_core.c should be readable in isolation as a textbook FORTH VM.

-------------------------------------------------------------------------------
vm_bootstrap.c  (VM BIRTH & OWNERSHIP)
-------------------------------------------------------------------------------

Purpose:
Owns VM creation and dictionary population.

Owns:
• vm_init / vm_create
• Dictionary allocation
• TIB, >IN, SPAN allocation
• Primitive registration
• Vocabulary setup
• Parity snapshot hook
• “Mama Forth” authority

Responsibilities:
• Register ALL primitives
• Assign XT ownership metadata
• Establish which XTs are executable
• Interface with HAL services ONLY through defined hooks

This file defines WHAT is valid to execute.

-------------------------------------------------------------------------------
vm_runtime.c  (TIME & ADAPTATION)
-------------------------------------------------------------------------------

Purpose:
Runtime control plane (heartbeat, time, inference hooks).

Owns:
• Heartbeat tick handling
• TIME / TICKS / HB words
• TIME-TRUST reporting
• Inference scheduling hooks (even if stubbed)
• Future L7 / L8 integration points

Rules:
• May CALL vm_core
• vm_core MUST NEVER call vm_runtime
• Policy logic lives here, not in vm_core

-------------------------------------------------------------------------------
HEADER SPLIT (CRITICAL)
-------------------------------------------------------------------------------

vm_core.h:
• Opaque struct vm
• Execution APIs only
• Stack accessors
• No HAL, no logging, no bootstrap symbols

vm_bootstrap.h:
• VM creation APIs
• Primitive registration APIs
• Dictionary manipulation
• Vocabulary APIs

No header may expose implementation details unnecessarily.

-------------------------------------------------------------------------------
XT VALIDATION REWORK (MANDATORY)
-------------------------------------------------------------------------------

Current behavior:
XT validity is incorrectly enforced via address window checks.

Required behavior:
XT validity MUST be based on ownership.

Implementation options (choose ONE):

A) Maintain an executable-region table populated at boot
B) Tag XTs with an owner/capability flag at registration
C) Maintain a whitelist of kernel-owned executable targets

vm_core MUST ask:
“Is this XT executable?”

vm_bootstrap MUST answer:
“Yes, I registered it.”

Do NOT hardcode __kernel_start / __kernel_end checks.

-------------------------------------------------------------------------------
BOOT FLOW (TARGET STATE)
-------------------------------------------------------------------------------

1. Kernel boots
2. HAL initialized
3. vm_bootstrap creates VM
4. Dictionary populated (primitives only)
5. Runtime hooks registered
6. Parity snapshot captured
7. Deterministic script executed
8. Interpreter enters REPL (later milestone)

-------------------------------------------------------------------------------
WHAT THIS IS NOT
-------------------------------------------------------------------------------

• Not a redesign
• Not a feature expansion
• Not a performance pass
• Not a merge into master
• Not a policy debate

This is a STRUCTURAL CORRECTION.

-------------------------------------------------------------------------------
SUCCESS CRITERIA
-------------------------------------------------------------------------------

• vm_core compiles without HAL or logging symbols
• vm_bootstrap owns ALL primitive registration
• XT validation no longer rejects legitimate modules
• M7 parity runs past module registration
• Heartbeat continues uninterrupted
• M7.md can advance cleanly after this

-------------------------------------------------------------------------------
NEXT STEP AFTER M7.5
-------------------------------------------------------------------------------

Return to M7:
• Finish parity validation
• Confirm dictionary equivalence with hosted build
• Continue toward REPL bring-up

===============================================================================
END OF M7.5
===============================================================================
